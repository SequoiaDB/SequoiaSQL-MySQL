--source include/have_sequoiadb.inc
--source suite/metadata_sync_sequoiadb/inc/insts_connect_sequoiadb.inc

#seqDB-19228
#Bug SEQUOIASQLMAINSTREAM-360
connection conn2;
--disable_warnings
set sql_mode=TRADITIONAL;
--enable_warnings
select @@SESSION.sql_mode;

connection conn1;
--disable_warnings
set sql_mode=NO_ENGINE_SUBSTITUTION;
select @@SESSION.sql_mode;
drop database if exists metaSync_19228;
--enable_warnings
create database metaSync_19228;
use metaSync_19228;
CREATE TABLE t1 (
  eintrag date NOT NULL default '0000-00-00'
);
--disable_warnings
set sql_mode=default;
--enable_warnings
show create table t1;

connection conn2;
show create table metaSync_19228.t1;
select @@SESSION.sql_mode;
--disable_warnings
set sql_mode=default;
--enable_warnings

#Case 22556
connection conn1;
--disable_warnings
drop database if exists metaSync_22556;
--enable_warnings
create database if not exists metaSync_22556 character set = 'latin1';
connection conn2;
create table metaSync_22556.t1 (a int key auto_increment);
connection conn1;
alter database metaSync_22556 character set = 'utf8';
connection conn2;
alter table metaSync_22556.t1 add column b int not null;

#check metaData
connection conn1;
show create database metaSync_22556;
#Bug SEQUOIASQLMAINSTREAM-864
show create table metaSync_22556.t1;
connection conn2;
show create database metaSync_22556;
show create table metaSync_22556.t1;

connection conn1;
alter database metaSync_22556 character set = 'latin2';
connection conn2;
drop table metaSync_22556.t1;

#check metaData
#Bug SEQUOIASQLMAINSTREAM-771
connection conn1;
show create database metaSync_22556;
--error 1146
show create table metaSync_22556.t1;
connection conn2;
show create database metaSync_22556;
--error 1146
show create table metaSync_22556.t1;

connection conn1;
drop database metaSync_22556;

#Case 22557
connection conn1;
--disable_warnings
drop database if exists metaSync_22557;
--enable_warnings
create database if not exists metaSync_22557 character set = 'latin1';
create table metaSync_22557.t1 (a int key auto_increment);
connection conn2;
delimiter //;
CREATE FUNCTION metaSync_22557.f1() RETURNS INTEGER
BEGIN
  DECLARE retn INTEGER;
  SELECT a FROM metaSync_22557.t1 INTO retn;
  RETURN retn;
END//
delimiter ;//
connection conn1;
alter database metaSync_22557 character set = 'utf8';
connection conn2;
alter function metaSync_22557.f1 comment 'modify function';

#check metaData
connection conn1;
show create database metaSync_22557;
#Bug SEQUOIASQLMAINSTREAM-864
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create function metaSync_22557.f1;
connection conn2;
show create database metaSync_22557;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create function metaSync_22557.f1;

connection conn1;
alter database metaSync_22557 character set = 'latin2';
connection conn2;
drop function metaSync_22557.f1;

#check metaData
#Bug SEQUOIASQLMAINSTREAM-771
connection conn1;
show create database metaSync_22557;
--error 1305
show create function metaSync_22557.f1;
connection conn2;
show create database metaSync_22557;
--error 1305
show create function metaSync_22557.f1;

connection conn1;
drop database metaSync_22557;

#Case 22558
connection conn1;
--disable_warnings
drop database if exists metaSync_22558;
--enable_warnings
create database if not exists metaSync_22558 character set = 'latin1';
create table metaSync_22558.account (acct_num int, amount decimal(10,2));
connection conn2;
create trigger metaSync_22558.ins_num1 before insert on account for each row set @sum = @sum + NEW.amount;
--replace_column 7 x
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create trigger metaSync_22558.ins_num1;

#Bug SEQUOIASQLMAINSTREAM-771
connection conn1;
--replace_column 7 x
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create trigger metaSync_22558.ins_num1;
alter database metaSync_22558 character set = 'utf8';
connection conn2;
drop trigger metaSync_22558.ins_num1;

#Bug SEQUOIASQLMAINSTREAM-771
connection conn1;
show create database metaSync_22558;
--error 1360
show create trigger metaSync_22558.ins_num1;
connection conn2;
show create database metaSync_22558;
--error 1360
show create trigger metaSync_22558.ins_num1;

connection conn1;
drop database metaSync_22558;

#Case 22560
connection conn1;
--disable_warnings
drop database if exists metaSync_22560;
--enable_warnings
create database if not exists metaSync_22560 character set = 'latin1';
create table metaSync_22560.t1(a int);
connection conn2;
create index a on metaSync_22560.t1(a);

connection conn1;
show create database metaSync_22560;
show create table metaSync_22560.t1;
connection conn2;
show create database metaSync_22560;
show create table metaSync_22560.t1;

connection conn1;
alter database metaSync_22560 character set = 'utf8';
connection conn2;
drop index a on metaSync_22560.t1;

connection conn1;
show create database metaSync_22560;
show create table metaSync_22560.t1;
connection conn2;
show create database metaSync_22560;
show create table metaSync_22560.t1;

connection conn1;
drop database metaSync_22560;

#Case 22562
connection conn1;
--disable_warnings
drop database if exists meta_sync_test;
--enable_warnings
create database if not exists meta_sync_test character set = 'latin1';
create table meta_sync_test.t1 (a int key auto_increment,b char(255));

connection conn2;
delimiter //;
CREATE FUNCTION meta_sync_test.f1() RETURNS INTEGER
BEGIN
  DECLARE retn INTEGER;
  SELECT a FROM meta_sync_test.t1 INTO retn;
  RETURN retn;
END//
delimiter ;//
connection conn1;
alter table meta_sync_test.t1 add c int not null default 10;
connection conn2;
alter function meta_sync_test.f1 comment 'modify function';

#check metaData
#Bug SEQUOIASQLMAINSTREAM-771
connection conn1;
show create table meta_sync_test.t1;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create function meta_sync_test.f1;
connection conn2;
show create table meta_sync_test.t1;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create function meta_sync_test.f1;

connection conn1;
alter table meta_sync_test.t1 change column c d bigint not null;
connection conn2;
drop function meta_sync_test.f1;

#check metaData
#Bug SEQUOIASQLMAINSTREAM-771
connection conn1;
show create table meta_sync_test.t1;
--error 1305
show create function meta_sync_test.f1;
connection conn2;
show create table meta_sync_test.t1;
--error 1305
show create function meta_sync_test.f1;

connection conn1;
drop table meta_sync_test.t1;

#Case 22563
connection conn1;
drop table if exists meta_sync_test.account;
create table meta_sync_test.account (acct_num int, amount decimal(10,2));
connection conn2;
create trigger meta_sync_test.ins_num1 before insert on account for each row set @sum = @sum + NEW.amount;

#Bug SEQUOIASQLMAINSTREAM-771
connection conn1;
show create table meta_sync_test.account;
--replace_column 7 x
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create trigger meta_sync_test.ins_num1;
connection conn2;
show create table meta_sync_test.account;
--replace_column 7 x
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create trigger meta_sync_test.ins_num1;

connection conn1;
alter table meta_sync_test.account add c int not null default 10;
connection conn2;
drop trigger meta_sync_test.ins_num1;

#Bug SEQUOIASQLMAINSTREAM-771
connection conn1;
show create table meta_sync_test.account;
--error 1360
show create trigger meta_sync_test.ins_num1;
connection conn2;
show create table meta_sync_test.account;
--error 1360
show create trigger meta_sync_test.ins_num1;

connection conn1;
drop table meta_sync_test.account;

#Case 22565
connection conn1;
drop table if exists meta_sync_test.t1;
drop table if exists meta_sync_test.t2;
create table meta_sync_test.t1(a int)engine=innodb;
connection conn2;
create index a on meta_sync_test.t1(a);

connection conn1;
show create table meta_sync_test.t1;
connection conn2;
show create table meta_sync_test.t1;

connection conn1;
alter table meta_sync_test.t1 rename as meta_sync_test.t2;
#Bug SEQUOIASQLMAINSTREAM-773
connection conn2;
alter table meta_sync_test.t2 rename index a to b;

connection conn1;
--error 1146
show create table meta_sync_test.t1;
show create table meta_sync_test.t2;
connection conn2;
--error 1146
show create table meta_sync_test.t1;
show create table meta_sync_test.t2;

connection conn1;
drop table meta_sync_test.t2;

#Case 22695
connection conn1;
create table meta_sync_test.t1(a int,b int);
connection conn2;
create table meta_sync_test.t2 like meta_sync_test.t1;
connection conn1;
create or replace view meta_sync_test.v1 as select * from meta_sync_test.t1 where a >0;
connection conn2;
alter table meta_sync_test.t1 add column c int;
connection conn1;
create or replace view meta_sync_test.v1 as select * from meta_sync_test.t2 where exists(select 1 from meta_sync_test.t1 where meta_sync_test.t1.a=meta_sync_test.t2.a);

#check metaData
#Bug SEQUOIASQLMAINSTREAM-771
connection conn1;
show create table meta_sync_test.t1;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create view meta_sync_test.v1;
connection conn2;
show create table meta_sync_test.t1;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create view meta_sync_test.v1;

connection conn1;
drop table meta_sync_test.t1;
connection conn2;
drop view meta_sync_test.v1;
drop table meta_sync_test.t2;

#check metaData
#Bug SEQUOIASQLMAINSTREAM-771
connection conn1;
--error 1146
show create table meta_sync_test.t1;
--error 1146
show create table meta_sync_test.v1;
connection conn2;
--error 1146
show create table meta_sync_test.t1;
--error 1146
show create table meta_sync_test.v1;

#Case 22696
connection conn1;
create table meta_sync_test.t1 (a int key auto_increment,b int);
create table meta_sync_test.t2 like meta_sync_test.t1;
create or replace view meta_sync_test.v1 as select * from meta_sync_test.t1 where a >0;
connection conn2;
delimiter //;
CREATE FUNCTION meta_sync_test.f1() RETURNS INTEGER
BEGIN
  DECLARE retn INTEGER;
  SELECT a FROM meta_sync_test.v1 INTO retn;
  RETURN retn;
END//
delimiter ;//

#check metaData
#Bug SEQUOIASQLMAINSTREAM-771
connection conn1;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create table meta_sync_test.v1;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create function meta_sync_test.f1;
connection conn2;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create table meta_sync_test.t1;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create function meta_sync_test.f1;

connection conn1;
drop view meta_sync_test.v1;

connection conn2;
alter function meta_sync_test.f1 comment 'modify function';
#check metaData
#Bug SEQUOIASQLMAINSTREAM-771
connection conn1;
--error 1146
show create table meta_sync_test.v1;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create function meta_sync_test.f1;
connection conn2;
--error 1146
show create table meta_sync_test.v1;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create function meta_sync_test.f1;

connection conn1;
create or replace view meta_sync_test.v1 as select * from meta_sync_test.t2 where exists(select 1 from meta_sync_test.t1 where meta_sync_test.t1.a=meta_sync_test.t2.a);
connection conn2;
drop function meta_sync_test.f1;

#check metaData
connection conn1;
drop view meta_sync_test.v1;
#Bug SEQUOIASQLMAINSTREAM-771
--error 1146
show create table meta_sync_test.v1;
--error 1305
show create function meta_sync_test.f1;
connection conn2;
--error 1146
show create table meta_sync_test.v1;
--error 1305
show create function meta_sync_test.f1;

connection conn1;
drop table meta_sync_test.t1;
drop table meta_sync_test.t2;



#Case 22698
connection conn1;
create table meta_sync_test.t1 (id int, name char(255));
connection conn2;
delimiter //;
create procedure meta_sync_test.p1()
begin
   insert into meta_sync_test.t1(name) values('name is null');
end //

create procedure meta_sync_test.p2()
begin
   insert into meta_sync_test.t1(name) values('name is not null');
end //
delimiter ;//

connection conn1;
delimiter //;
create function meta_sync_test.f(num int) returns int
begin
   declare a int;
   if num <0 then
      call meta_sync_test.p1();
      set a= 1;
   else
      call meta_sync_test.p2();
      set a=2;
   end if;
   return a;
end //
delimiter ;//

#Bug SEQUOIASQLMAINSTREAM-771
connection conn2;
create view meta_sync_test.v1 as select * from meta_sync_test.t1 where id = meta_sync_test.f(-1);

#check metaData
#Bug SEQUOIASQLMAINSTREAM-771
connection conn1;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create table meta_sync_test.v1;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create function meta_sync_test.f;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create procedure meta_sync_test.p1;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create procedure meta_sync_test.p2;
show create table meta_sync_test.t1;
connection conn2;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create table meta_sync_test.v1;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create function meta_sync_test.f;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create procedure meta_sync_test.p1;
--replace_regex /DEFINER=`.*`@/DEFINER=`x`@/
show create procedure meta_sync_test.p2;
show create table meta_sync_test.t1;

connection conn1;
drop table meta_sync_test.t1;
connection conn2;
drop procedure meta_sync_test.p1;
drop procedure meta_sync_test.p2;
connection conn1;
drop function meta_sync_test.f;
connection conn2;
drop view meta_sync_test.v1;

#check metaData
#Bug SEQUOIASQLMAINSTREAM-771
connection conn1;
connection conn1;
--error 1146
show create table meta_sync_test.v1;
--error 1305
show create function meta_sync_test.f;
--error 1305
show create procedure meta_sync_test.p1;
--error 1305
show create procedure meta_sync_test.p2;
--error 1146
show create table meta_sync_test.t1;
connection conn2;
--error 1146
show create table meta_sync_test.v1;
--error 1305
show create function meta_sync_test.f;
--error 1305
show create procedure meta_sync_test.p1;
--error 1305
show create procedure meta_sync_test.p2;
--error 1146
show create table meta_sync_test.t1;

#Case 22567
connection conn1;
--disable_warnings
drop database if exists meta_sync_22567;
drop user if exists user_22567;
--enable_warnings
create database meta_sync_22567;
create table meta_sync_22567.t1(a int);
create view meta_sync_22567.v1 as select * from meta_sync_22567.t1;
delimiter //;
create procedure meta_sync_22567.p1()
begin
   insert into meta_sync_22567.t1(name) values('name is null');
end //
CREATE FUNCTION meta_sync_22567.f1() RETURNS INTEGER 
BEGIN
  DECLARE retn INTEGER;
  insert into meta_sync_22567.t1(a) values(1) ;
  SELECT a FROM meta_sync_22567.t1 INTO retn;
  RETURN retn;
END//
delimiter ;//
create user user_22567 identified by 'meta_sync_22567';
flush privileges;
connection conn2;
grant insert on table meta_sync_22567.t1 to 'user_22567';
grant select on table meta_sync_22567.v1 to 'user_22567';
grant execute on function meta_sync_22567.f1 to 'user_22567';
grant execute on procedure meta_sync_22567.p1 to 'user_22567';
flush privileges;

--sorted_result
connection conn1;
show grants for user_22567;
--sorted_result
connection conn2;
show grants for user_22567;

connection conn1;
revoke insert on table meta_sync_22567.t1 from user_22567;
revoke select on table meta_sync_22567.v1 from user_22567;
revoke execute on function meta_sync_22567.f1 from user_22567;
revoke execute on procedure meta_sync_22567.p1 from user_22567;
flush privileges;

connection conn1;
show grants for user_22567;
connection conn2;
show grants for user_22567;

connection conn1;
grant all on meta_sync_22567.* to 'user_22567';
flush privileges;

connection conn1;
show grants for user_22567;
connection conn2;
show grants for user_22567;

connection conn1;
alter database meta_sync_22567 character set = 'latin2';
connection conn2;
revoke all on meta_sync_22567.* from user_22567;
flush privileges;

connection conn1;
show grants for user_22567;
connection conn2;
show grants for user_22567;

connection conn1;
drop table meta_sync_22567.t1;
connection conn2;
drop view meta_sync_22567.v1;
connection conn1;
drop function meta_sync_22567.f1;
connection conn2;
drop procedure meta_sync_22567.p1;

connection conn1;
show grants for user_22567;
connection conn2;
show grants for user_22567;

connection conn1;
drop database meta_sync_22567;
drop user user_22567;

--source include/uninstall_sequoiadb.inc
--source suite/metadata_sync_sequoiadb/inc/insts_disconnect_sequoiadb.inc
