#Case 18635#Case 20547#Case 20548#Case 20549#Case 20550#Case 20551#Case 20552#Case 20555
#Case 13167

--source include/have_sequoiadb.inc

--disable_query_log
CALL mtr.add_suppression(".*failed to query with condition.*rc: 40013");
--enable_query_log

#seqDB-18635
#create sessions
connect (con1, localhost, root);
connect (con2, localhost, root);

connection default;
create table t1(a int primary key)engine=sequoiadb; 
connection con1;
select @@autocommit;
connection con2;
select @@autocommit;
#session1 insert
connection con1;
begin;
insert into t1 values(1);

#sesson2 insert error,then select and insert
connection con2;
begin;
--error 1062
insert into t1 values(1); 
select * from t1; 
insert into t1 values(2);
select * from t1;

#session1 commit,then select
connection con1;
commit; 
select * from t1; 

#session2 commit,then select
connection con2;
commit; 
select * from t1;

connection default;
drop table t1;

connection con1;
set session autocommit = 0;
select @@autocommit;
connection con2;
set session autocommit = 0;
select @@autocommit;
connection default;
create table t1(a int primary key)engine=sequoiadb; 
#session1 insert
connection con1;
begin;
insert into t1 values(1);

#sesson2 insert error,then select and insert
connection con2;
begin;
--error 1062
insert into t1 values(1); 
select * from t1; 
insert into t1 values(2);
select * from t1;

#session1 commit,then select
connection con1;
commit; 
select * from t1; 
commit;

#session2 commit,then select
connection con2;
commit; 
select * from t1;
commit;

connection default;
drop table t1;

# MULTI-TABLE
connection default;
create table t1 (id int); 
create table t2 (id int,  s1 text); 
insert into t1 values (1),(2),(3); 
insert into t2 values (1,'test'), (2,'test'), (3,'test'); 
update t1 left join t2 using(id) set s1 = 'changed';  
--sorted_result
select * from t1 left join t2 using(id);

#SEQUOIASQLMAINSTREAM-316
#
# MULTI-UPDATE
#
connection con1;
begin;
update t1 left join t2 using(id) set s1 = 'changed1'; 

connection con2;
--error 1205 
update t1 left join t2 using(ID) set s1 = 'changed2'; 
commit;

connection con1;
commit;

connection default;
--sorted_result
select * from t1 left join t2 using(id);

connection con2;
begin;
update t1 left join t2 using(ID) set s1 = 'test'; 
commit;

connection default;
--sorted_result
select * from t1 left join t2 using(id);

#SEQUOIASQLMAINSTREAM-316
#
# MULTI-DELETE
#
connection con1;
begin;
delete t1, t2 from t1 left join t2 on t1.id=t2.id where t1.id > 1;

connection con2;
--error 1205 
delete t1, t2 from t1 left join t2 on t1.id=t2.id;
commit;

connection con1;
commit;

connection default;
--sorted_result
select * from t1 left join t2 using(id);

connection con2;
begin;
delete t1, t2 from t1 left join t2 on t1.id=t2.id;
commit;
  
connection default;
--sorted_result
select * from t1 left join t2 using(id);

drop table t1,t2;

#seqDB-20547
#default sequoiadb_rollback_on_timeout=OFF
create table t1 ( id int, id1 int, c char(16), index (id) );
insert into t1 values (1,1,'a'), (2,2,'b'), (3,3,'c');
#session1 update
connection con1;
begin;
update t1 set c = 'updateC' where id = 3;
#session2 select timeout
connection con2;
begin;
insert into t1 values (4,4,'d');
--error 1205
select * from t1 where id = 3 for update;
select * from t1;
#session2 commit
insert into t1 values (5,5,'e'),(6,6,'f');
delete from t1 where id = 1;
update t1 set c = 'updateE' where id = 5;
commit;
connection default;
select * from t1;
#session2 select timeout
connection con2;
begin;
--error 1205
select * from t1 where id = 3 for update;
#session2 rollback
insert into t1 values (7,7,'h');
delete from t1 where id = 4;
update t1 set c = 'updateF' where id = 6;
rollback;
#session1 commit
connection con1;
commit;
connection default;
select * from t1;
delete from t1;

#seqDB-20548
insert into t1 values (1,2,'a'),(2,3,'b'), (3,3,'c');
#session1 update
connection con1;
begin;
update t1 set c = 'updateC' where id = 3;
#session2 update timeout, condition not pushdown
connection con2;
begin;
delete from t1 where id = 2;
--error 1205
update t1 set c = 'otherC' where not id = id1 - 1;
select * from t1;
#session2 commit
insert into t1 values (4,4,'d'),(5,5,'e');
delete from t1 where id = 1;
update t1 set c = 'updateD' where id = 4;
commit;
connection default;
select * from t1;
#session2 update timeout, condition pushdown
connection con2;
begin;
--error 1205
update t1 set c = 'updateAll' where id > 0;
select * from t1;
#session2 rollback
insert into t1 values (6,6,'f');
delete from t1 where id = 4;
update t1 set c = 'updateE' where id = 5;
rollback;
#session1
connection con1;
commit;
connection default;
select * from t1;
delete from t1;

#seqDB-20549
insert into t1 values (1,2,'a'),(2,3,'b'), (3,3,'c');
#session1 delete
connection con1;
begin;
delete from t1 where id = 3;
#session2 delete timeout, condition not pushdown
connection con2;
begin;
update t1 set c = 'updateB' where id = 2;
--error 1205
delete from t1 where not id = id1 - 1;
select * from t1;
#session2 commit
insert into t1 values (4,4,'d'),(5,5,'e');
delete from t1 where id = 1;
update t1 set c = 'updateD' where id = 4;
commit;
connection default;
select * from t1;
#session2 delete timeout, condition pushdown
connection con2;
begin;
--error 1205
delete from t1 where id > 0;
select * from t1;
#session2 rollback
insert into t1 values (6,6,'f'),(7,7,'g');
rollback;
#session1
connection con1;
commit;
connection default;
select * from t1;
delete from t1;
disconnect con1;
disconnect con2;

connect (con1, localhost, root);
connect (con2, localhost, root);

#SeqDB-20550
insert into t1 values (1,1,'a'), (2,2,'b'), (3,3,'c');
#session1 update
connection con1;
set sequoiadb_rollback_on_timeout = on;
begin;
update t1 set c = 'updateC' where id = 3;
#session2 select timeout
connection con2;
set sequoiadb_rollback_on_timeout = on;
begin;
insert into t1 values (4,4,'d');
--error 1205
select * from t1 where id = 3 for update;
select * from t1;
#session2 commit
insert into t1 values (5,5,'e'),(6,6,'f');
delete from t1 where id = 1;
update t1 set c = 'updateE' where id = 5;
commit;
connection default;
set sequoiadb_rollback_on_timeout = on;
select * from t1;
#session2 select timeout
connection con2;
set sequoiadb_rollback_on_timeout = on;
begin;
--error 1205
select * from t1 where id = 3 for update;
#session2 rollback
insert into t1 values (7,7,'h');
delete from t1 where id = 4;
update t1 set c = 'updateF' where id = 6;
rollback;
#session1 commit
connection con1;
set sequoiadb_rollback_on_timeout = on;
commit;
connection default;
set sequoiadb_rollback_on_timeout = on;
select * from t1;
delete from t1;
disconnect con1;
disconnect con2;

set global sequoiadb_rollback_on_timeout = on;
connect (con1, localhost, root);
connect (con2, localhost, root);

#SeqDB-20551
insert into t1 values (1,2,'a'),(2,3,'b'), (3,3,'c');
#session1 update
connection con1;
begin;
update t1 set c = 'updateC' where id = 3;
#session2 update timeout, condition not pushdown
connection con2;
begin;
delete from t1 where id = 2;
--error 1205
update t1 set c = 'otherC' where not id = id1 - 1;
select * from t1;
#session2 commit
insert into t1 values (4,4,'d'),(5,5,'e');
delete from t1 where id = 1;
update t1 set c = 'updateD' where id = 4;
commit;
connection default;
select * from t1;
#session2 update timeout, condition pushdown
connection con2;
begin;
--error 1205
update t1 set c = 'updateAll' where id > 0;
select * from t1;
#session2 rollback
insert into t1 values (6,6,'f');
delete from t1 where id = 4;
update t1 set c = 'updateE' where id = 5;
rollback;
#session1
connection con1;
commit;
connection default;
select * from t1;
delete from t1;

#seqDB-20552
insert into t1 values (1,2,'a'),(2,3,'b'), (3,3,'c');
#session1 delete
connection con1;
begin;
delete from t1 where id = 3;
#session2 delete timeout, condition not pushdown
connection con2;
begin;
update t1 set c = 'updateB' where id = 2;
--error 1205
delete from t1 where not id = id1 - 1;
select * from t1;
#session2 commit
insert into t1 values (4,4,'d'),(5,5,'e');
delete from t1 where id = 1;
update t1 set c = 'updateD' where id = 4;
commit;
connection default;
select * from t1;
#session2 delete timeout, condition pushdown
connection con2;
begin;
--error 1205
delete from t1 where id > 0;
select * from t1;
#session2 rollback
insert into t1 values (6,6,'f'),(7,7,'g');
rollback;
#session1
connection con1;
commit;
connection default;
select * from t1;
set global sequoiadb_rollback_on_timeout = off;
drop table t1;

#BUG #SEQUOIASQLMAINSTREAM-670
#seqDB-13167
connection con1;
create table t1( id int );
insert into t1 values (1),(0),(2);
begin;
insert into t1 values (10),(11);
delete from t1 where id = 0;
alter table t1 add index id(id);
rollback;
select * from t1 order by id;
drop table t1;

#seqDB-22401
connection default;
create table t1(id int);
connection con1;
SET GLOBAL TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
BEGIN;
SELECT * FROM t1;

connection con2;
BEGIN;
INSERT INTO t1 VALUES(1);

connection con1;
SELECT * FROM t1;

connection con2;
COMMIT;

connection con1;
SELECT * FROM t1;
disconnect con1;

connect (con1, localhost, root);
connection con1;
BEGIN;
SELECT * FROM t1;

connection con2;
BEGIN;
INSERT INTO t1 VALUES(2);

connection con1;
SELECT * FROM t1;
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
SELECT * FROM t1;
COMMIT;
BEGIN;
SELECT * FROM t1;
--error 1568
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT * FROM t1;
ROLLBACK;

connection con2;
ROLLBACK;

connection con1;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
BEGIN;
SELECT * FROM t1;

connection con2;
BEGIN;
INSERT INTO t1 VALUES(2);
COMMIT;

connection con1;
SELECT * FROM t1;
COMMIT;

BEGIN;
SELECT * FROM t1;
COMMIT;
SET GLOBAL TRANSACTION ISOLATION LEVEL REPEATABLE READ;

#SET GLOBAL TRANSACTION ISOLATION LEVEL SERIALIZABLE;
#disconnect con1;
#
#Bug #SEQUOIASQLMAINSTREAM-721
#connect (con1, localhost, root);
#connection con1;
#BEGIN;
#--error 200
#SELECT * FROM t1;
#ROLLBACK;
#
#SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;
#BEGIN;
#--error 200
#SELECT * FROM t1;
#ROLLBACK;
#
#SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
#BEGIN;
#--error 200
#SELECT * FROM t1;
#ROLLBACK;

connection default;
DROP TABLE t1;

disconnect con1;
disconnect con2;
