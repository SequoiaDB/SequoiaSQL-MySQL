#Case 20412#Case 20413#Case 20414#Case 20415#Case 20416#Case 20417#Case 20418
#Case 20419#Case 20420#Case 20421#Case 20540#Case 22271#Case 22296#Case 22332

--source include/have_sequoiadb.inc

#seqDB-20412
CREATE TABLE t1 ( a INT, b INT, c CHAR(3), d INT )
PARTITION BY RANGE COLUMNS(a,d,c) (
    PARTITION p0 VALUES LESS THAN (5,10,'ggg'),
    PARTITION p1 VALUES LESS THAN (10,20,'mmm'),
    PARTITION p2 VALUES LESS THAN (15,30,'sss'),
    PARTITION p3 VALUES LESS THAN (MAXVALUE,MAXVALUE,MAXVALUE)
);
SHOW CREATE TABLE t1;
DROP TABLE t1;

#seqDB-20413 
CREATE TABLE t1 (
    id INT NOT NULL,
    fname VARCHAR(30),
    lname VARCHAR(30),
    hired DATE NOT NULL DEFAULT '1970-01-01',
    separated DATE NOT NULL DEFAULT '9999-12-31',
    job_code INT NOT NULL,
    store_id INT NOT NULL
)
PARTITION BY RANGE (store_id) (
    PARTITION p0 VALUES LESS THAN (6),
    PARTITION p1 VALUES LESS THAN (11),
    PARTITION p2 VALUES LESS THAN (16),
    PARTITION p3 VALUES LESS THAN (21)
);
SHOW CREATE TABLE t1;
DROP TABLE t1;

#seqDB-20414
CREATE TABLE t1 (
    id INT NOT NULL,
    fname VARCHAR(30),
    lname VARCHAR(30),
    hired DATE NOT NULL DEFAULT '1970-01-01',
    separated DATE NOT NULL DEFAULT '9999-12-31',
    job_code INT,
    store_id INT
)
PARTITION BY RANGE ( YEAR(separated) ) (
    PARTITION p0 VALUES LESS THAN (1991),
    PARTITION p1 VALUES LESS THAN (1996),
    PARTITION p2 VALUES LESS THAN (2001),
    PARTITION p3 VALUES LESS THAN MAXVALUE
);
SHOW CREATE TABLE t1;
DROP TABLE t1;

#seqDB-20415
CREATE TABLE t1 (
    first_name VARCHAR(25),
    last_name VARCHAR(25),
    street_1 VARCHAR(30),
    street_2 VARCHAR(30),
    city VARCHAR(15),
    renewal DATE
)
PARTITION BY LIST COLUMNS(city) (
    PARTITION pRegion_1 VALUES IN('Oskarshamn', 'Högsby', 'Mönsterås'),
    PARTITION pRegion_2 VALUES IN('Vimmerby', 'Hultsfred', 'Västervik'),
    PARTITION pRegion_3 VALUES IN('Nässjö', 'Eksjö', 'Vetlanda'),
    PARTITION pRegion_4 VALUES IN('Uppvidinge', 'Alvesta', 'Växjo')
);
SHOW CREATE TABLE t1;
DROP TABLE t1;

#seqDB-20416
CREATE TABLE t1 (
    id INT NOT NULL,
    hired DATETIME NOT NULL
)
PARTITION BY LIST( YEAR(hired) ) 
(
    PARTITION a VALUES IN (1990),
    PARTITION b VALUES IN (1991),
    PARTITION c VALUES IN (1992),
    PARTITION d VALUES IN (1993)
);
SHOW CREATE TABLE t1;
DROP TABLE t1;

#seqDB-20417
CREATE TABLE t1 (col1 INT, col2 CHAR(5), col3 DATE) COMMENT 'sequoiadb:{ table_options: { ReplSize: 2 } }'
    PARTITION BY LINEAR HASH( YEAR(col3) ) 
    PARTITIONS 6;
SHOW CREATE TABLE t1;
ALTER TABLE t1 COMMENT 'sequoiadb:{ table_options: { ReplSize: -1 } }';
SHOW CREATE TABLE t1;
--error 1210
ALTER TABLE t1 COMMENT 'sequoiadb:{ table_options: { ReplSize: 0 }, partition_options: {Partition: 8192} }';
SHOW CREATE TABLE t1;
DROP TABLE t1;
--error 140
CREATE TABLE t1 (col1 INT, col2 CHAR(5), col3 DATE) COMMENT 'sequoiadb:{ partition_options: { Partition: 8192} }'
    PARTITION BY LINEAR HASH( YEAR(col3) )
    PARTITIONS 6;

#seqDB-20418
CREATE TABLE t1 (
    col1 INT NOT NULL,
    col2 CHAR(5),
    col3 DATE
) COMMENT 'sequoiadb:{ table_options: { ReplSize: 2 } }'
PARTITION BY LINEAR KEY (col1)
PARTITIONS 3;
SHOW CREATE TABLE t1;
ALTER TABLE t1 COMMENT 'sequoiadb:{ table_options: { ReplSize: -1 } }';
SHOW CREATE TABLE t1;
--error 1210
ALTER TABLE t1 COMMENT 'sequoiadb:{ table_options: { ReplSize: 0 }, partition_options: {Partition: 8192} }';
SHOW CREATE TABLE t1;
DROP TABLE t1;
#Bug #SEQUOIASQLMAINSTREAM-699
#--error 140
#CREATE TABLE t1 (
#    col1 INT NOT NULL,
#    col2 CHAR(5),
#    col3 DATE
#) COMMENT 'sequoiadb:{ partition_options: {Partition: 8192} }'
#PARTITION BY LINEAR KEY (col1)
#PARTITIONS 3;

#seqDB-20419
CREATE TABLE t1 ( id INT, purchased DATE ) COMMENT 'sequoiadb:{ table_options: { ReplSize: 0 }, partition_options: {Partition: 8192} }'
    PARTITION BY RANGE( YEAR(purchased) )
    SUBPARTITION BY LINEAR HASH( TO_DAYS(purchased) )
    SUBPARTITIONS 2 (
        PARTITION p0 VALUES LESS THAN (1990),
        PARTITION p1 VALUES LESS THAN (2000),
        PARTITION p2 VALUES LESS THAN MAXVALUE
    );
CREATE TABLE t2 (id INT, purchased DATE)
    PARTITION BY RANGE( YEAR(purchased) )
    SUBPARTITION BY HASH( TO_DAYS(purchased) ) (
        PARTITION p0 VALUES LESS THAN (1990) (
            SUBPARTITION s0,
            SUBPARTITION s1
        ),
        PARTITION p1 VALUES LESS THAN (2000) (
            SUBPARTITION s2,
            SUBPARTITION s3
        ),
        PARTITION p2 VALUES LESS THAN MAXVALUE (
            SUBPARTITION s4,
            SUBPARTITION s5
        )
);
SHOW CREATE TABLE t1;
SHOW CREATE TABLE t2;
DROP TABLE t1,t2;

#seqDB-20420
CREATE TABLE t1 ( id INT, purchased DATE ) COMMENT 'sequoiadb:{ table_options: { ReplSize: 0 }, partition_options: {Partition: 8192} }'
    PARTITION BY LIST( id )
    SUBPARTITION BY LINEAR KEY ( id )
    SUBPARTITIONS 2 (
        PARTITION p0 VALUES IN (10),
        PARTITION p1 VALUES IN (20),
        PARTITION p2 VALUES IN (30)
    ); 
SHOW CREATE TABLE t1;
DROP TABLE t1;

#seqDB-20421
CREATE TABLE t1 ( id INT, purchased DATE )
    COMMENT 'sequoiadb: { table_options: { ReplSize: -1}, partition_options: { Partition: 1024 }}'
    PARTITION BY RANGE( YEAR(purchased) )
    SUBPARTITION BY HASH( TO_DAYS(purchased) )
    SUBPARTITIONS 2 (
        PARTITION p0 VALUES LESS THAN(1990)
            COMMENT 'sequoiadb: { partition_options : { Partition: 1024, ReplSize: 2 } }',
        PARTITION p1 VALUES LESS THAN(2000)
            COMMENT 'sequoiadb: { partition_options : { Partition: 2048, Compressed: true, CompressionType:"snappy" } }',   
        PARTITION p2 VALUES LESS THAN MAXVALUE
            COMMENT 'sequoiadb: { partition_options : { Partition: 8192, ReplSize: 3, StrictDataMode: true } }'  
    );		       
SHOW CREATE TABLE t1;
--error 40032
ALTER TABLE t1 COMMENT 'sequoiadb: { table_options: {ReplSize: 1, StrictDataMode: true, AutoIndexId: true, AutoSplit: false}}';
--error 40032
ALTER TABLE t1 COMMENT 'sequoiadb: { partition_options: {ReplSize: 1, StrictDataMode: true, AutoIndexId: true, AutoSplit: false}}';

ALTER TABLE t1 COMMENT 'sequoiadb: { table_options: {ReplSize: 1}}';
ALTER TABLE t1 COMMENT 'sequoiadb: { table_options: {ReplSize: 2}, partition_options: {ReplSize: 1, AutoIndexId: true, AutoSplit: true, Compressed:true, StrictDataMode: true, Partition: 8192}}';

DROP TABLE t1;

#seqDB-20540
CREATE TABLE t1 (
    id INT NOT NULL PRIMARY KEY,
    name VARCHAR(20)
)
PARTITION BY KEY()
PARTITIONS 2;

CREATE TABLE t2 (
    id INT NOT NULL UNIQUE KEY,
    name VARCHAR(20)
)
PARTITION BY KEY()
PARTITIONS 2;
SHOW CREATE TABLE t1;
SHOW CREATE TABLE t2;
DROP TABLE t1,t2;

#seqDB-22271
CREATE TABLE `t1#P#pp` ( 
    id INT NOT NULL, 
    produced_date DATE
) 
PARTITION BY RANGE COLUMNS (produced_date) ( 
    PARTITION p0 VALUES LESS THAN ('1990-01-01'), 
    PARTITION p1 VALUES LESS THAN ('2000-01-01'), 
    PARTITION p2 VALUES LESS THAN ('2010-01-01'), 
    PARTITION p3 VALUES LESS THAN ('2020-01-01') 
); 
CREATE TABLE `t2#P#pp` ( 
    id INT NOT NULL, 
    c INT,
    PRIMARY KEY(id,c)
) 
PARTITION BY LIST (id)
SUBPARTITION BY HASH(c)
SUBPARTITIONS 2
(PARTITION p0 VALUES IN (0),
 PARTITION p1 VALUES IN (100),
 PARTITION p2 VALUES IN (1000),
 PARTITION p3 VALUES IN (10000)
);
INSERT INTO `t1#P#pp` VALUES (1, '1989-01-01'), (2, '1999-01-01'),(3, '2009-01-01'),(4, '2019-01-01');
INSERT INTO `t2#P#pp` VALUES (0, 0),(100, 100),(1000, 1000),(10000, 10000);
SHOW CREATE TABLE `t1#P#pp`;
SHOW CREATE TABLE `t2#P#pp`;
ALTER TABLE `t1#P#pp` DROP PARTITION p3; 
ALTER TABLE `t2#P#pp` DROP PARTITION p1,p2; 
SHOW CREATE TABLE `t1#P#pp`;
SHOW CREATE TABLE `t2#P#pp`;
SELECT * FROM `t1#P#pp` ORDER BY id;
SELECT * FROM `t2#P#pp` ORDER BY id;
DROP TABLE `t1#P#pp`,`t2#P#pp`;


#seqDB-22296
CREATE TABLE t1 ( 
id INT, 
dt DATE
) 
PARTITION BY LIST(YEAR(dt)) # TEST _phid_
(PARTITION p1 VALUES IN (1970,1990), 
PARTITION p2 VALUES IN (2000,2008), 
PARTITION p3 VALUES IN (2020)); 
# FAIL TO ADD UNIQUE KEY WITHOUT SHARDINGKEY
--error 40177
ALTER TABLE t1 ADD UNIQUE INDEX uid (id); 
SHOW CREATE TABLE t1;
ALTER TABLE t1 PARTITION BY RANGE COLUMNS (dt) ( # TEST col_list
    PARTITION d1 VALUES LESS THAN ('1970-01-01'),
    PARTITION d2 VALUES LESS THAN ('2000-02-02'),
    PARTITION d3 VALUES LESS THAN ('2020-03-03')
);
--error 40177
ALTER TABLE t1 ADD UNIQUE INDEX uid (id);
SHOW CREATE TABLE t1;
DROP TABLE t1;

#seqDB-22332
CREATE TABLE t1(a INT) COMMENT 'sequoiadb:{ table_options: { ReplSize: 2 } }';
SHOW CREATE TABLE t1;
ALTER TABLE t1 COMMENT 'sequoiadb:{ table_options: { ReplSize: 1 } }';
SHOW CREATE TABLE t1;
--error 1210
ALTER TABLE t1 COMMENT 'sequoiadb:{ table_options: { ReplSize: 0 }, partition_options: { Partition: 8192 } }';
DROP TABLE t1;
--error 1210
CREATE TABLE t1(a INT) COMMENT 'sequoiadb:{ partition_options: { Partition: 8192 } }';

#seqDB-22393
CREATE TABLE t1 (
    id INT NOT NULL,
    produced_date DATE,
    name VARCHAR(100),
    company VARCHAR(100)
)COMPRESSION "None"
COMMENT 'sequoiadb:{ partition_options: { Compressed : true, CompressionType: "snappy" } }'
PARTITION BY RANGE COLUMNS (produced_date)
SUBPARTITION BY KEY (id)
SUBPARTITIONS 2 (
    PARTITION p0 VALUES LESS THAN ('1990-01-01') COMMENT 'sequoiadb:{ partition_options: { Compressed: true, CompressionType: "lzw" } }',
    PARTITION p1 VALUES LESS THAN ('2000-01-01'),
    PARTITION p2 VALUES LESS THAN ('2010-01-01')
);
SHOW CREATE TABLE t1; 
ALTER TABLE t1 COMPRESSION "None" COMMENT 'sequoiadb:{ partition_options: { Compressed : true, CompressionType: "lzw" } }';
SHOW CREATE TABLE t1; 
DROP TABLE t1;

#Bug #SEQUOIASQLMAINSTREAM-715
#CREATE TABLE t1 (
#    id INT NOT NULL,
#    produced_date DATE,
#    name VARCHAR(100),
#    company VARCHAR(100)
#)COMPRESSION "lzw"
#COMMENT 'sequoiadb:{ partition_options: { Compressed: false } }'
#PARTITION BY RANGE COLUMNS (produced_date)
#SUBPARTITION BY KEY (id)
#SUBPARTITIONS 2 (
#    PARTITION p0 VALUES LESS THAN ('1990-01-01'),
#    PARTITION p1 VALUES LESS THAN ('2000-01-01'),
#    PARTITION p2 VALUES LESS THAN ('2010-01-01')
#); 

#Bug #SEQUOIASQLMAINSTREAM-715
#CREATE TABLE t1 (
#    id INT NOT NULL,
#    produced_date DATE,
#    name VARCHAR(100),
#    company VARCHAR(100)
#)COMPRESSION "lzw"
#PARTITION BY RANGE COLUMNS (produced_date)
#SUBPARTITION BY KEY (id)
#SUBPARTITIONS 2 (
#    PARTITION p0 VALUES LESS THAN ('1990-01-01') COMMENT 'sequoiadb:{ partition_options: { Compressed: false } }',
#    PARTITION p1 VALUES LESS THAN ('2000-01-01'),
#    PARTITION p2 VALUES LESS THAN ('2010-01-01')
#); 

#seqDB-22333
--error 1166
CREATE TABLE t1(
   id INT,
   _phid_ INT
)
PARTITION BY RANGE COLUMNS (_phid_) (
    PARTITION p0 VALUES LESS THAN (6),
    PARTITION p1 VALUES LESS THAN (11),
    PARTITION p2 VALUES LESS THAN (16),
    PARTITION p3 VALUES LESS THAN (21)
);

--error 1166
CREATE TABLE t1(
   id INT,
   _phid_ INT
)
PARTITION BY RANGE (_phid_) (
    PARTITION p0 VALUES LESS THAN (6),
    PARTITION p1 VALUES LESS THAN (11),
    PARTITION p2 VALUES LESS THAN (16),
    PARTITION p3 VALUES LESS THAN (21)
);

--error 1166
CREATE TABLE t1(
   id INT,
   _phid_ INT
)
PARTITION BY KEY (_phid_)
PARTITIONS 4;

#seqDB-22334
--error 140
CREATE TABLE t1(
   id int auto_increment primary key
)
PARTITION BY RANGE COLUMNS ( id ) (
    PARTITION p0 VALUES LESS THAN (6),
    PARTITION p1 VALUES LESS THAN (11),
    PARTITION p2 VALUES LESS THAN (16),
    PARTITION p3 VALUES LESS THAN (21)
);

#seqDB-22370
CREATE TABLE t1(id int, a int) COMMENT 'sequoiadb:{ partition_options: { ShardingKey: {a:1} } }'
PARTITION BY LIST ( id ) (
    PARTITION p0 VALUES IN (1,3,5),
    PARTITION p1 VALUES IN (2,4,8),
    PARTITION p2 VALUES IN (6,10),
    PARTITION p3 VALUES IN (7,9)
);
SHOW CREATE TABLE t1;
DROP TABLE t1;

--error 1210
CREATE TABLE t1(id int, a int) COMMENT 'sequoiadb:{ table_options: { ShardingKey: {a:1} } }'
PARTITION BY LIST ( id ) (
    PARTITION p0 VALUES IN (1,3,5),
    PARTITION p1 VALUES IN (2,4,8),
    PARTITION p2 VALUES IN (6,10),
    PARTITION p3 VALUES IN (7,9)
);

#seqDB-22336
CREATE TABLE t1 (
    age INT,
    city VARCHAR(15)
);
SHOW CREATE TABLE t1;
INSERT INTO t1 VALUES(2,'a'),(6,'b'),(7,'c');
SELECT * FROM t1 ORDER BY age;
ALTER TABLE t1 PARTITION BY LIST ( age ) (
    PARTITION p0 VALUES IN (1,3,5),
    PARTITION p1 VALUES IN (2,4,8),
    PARTITION p2 VALUES IN (6,10),
    PARTITION p3 VALUES IN (7,9)
);
SHOW CREATE TABLE t1;
SELECT * FROM t1 ORDER BY age;
INSERT INTO t1 PARTITION(p0) VALUES(1,'d');
SELECT * FROM t1 PARTITION(p0);
UPDATE t1 PARTITION(p1) SET city = 'e';
SELECT * FROM t1 PARTITION(p1);
DELETE FROM t1 PARTITION(p2) WHERE age > 3;
SELECT * FROM t1 PARTITION(p2);

ALTER TABLE t1 PARTITION BY HASH( age ) PARTITIONS 4;
SHOW CREATE TABLE t1;
SELECT * FROM t1 ORDER BY age;
INSERT INTO t1 VALUES(200,'w');
SELECT * FROM t1 ORDER BY age;
UPDATE t1 SET city = 'ccc' WHERE age > 100;
SELECT * FROM t1 ORDER BY age;
DELETE FROM t1 WHERE age > 60;
SELECT * FROM t1 ORDER BY age;

ALTER TABLE t1 REMOVE PARTITIONING;
SHOW CREATE TABLE t1;
SELECT * FROM t1 ORDER BY age;
INSERT INTO t1 VALUES(555,'666');
SELECT * FROM t1 ORDER BY age;
DROP TABLE t1;

#seqDB-22337
CREATE TABLE t1 (
    age INT,
    name VARCHAR(15)
)
PARTITION BY LIST ( age ) (
    PARTITION p0 VALUES IN (1,3,5),
    PARTITION p1 VALUES IN (2,4,8),
    PARTITION p2 VALUES IN (6,10),
    PARTITION p3 VALUES IN (7,9)
);
SHOW CREATE TABLE t1;
INSERT INTO t1 VALUES(1,'1'),(2,'2'),(6,'6'),(7,'7');
SELECT * FROM t1 PARTITION(p0);
ALTER TABLE t1 TRUNCATE PARTITION p0;
SELECT * FROM t1 PARTITION(p0);
SELECT * FROM t1 ORDER BY age;
ALTER TABLE t1 TRUNCATE PARTITION all;
SELECT * FROM t1 ORDER BY age;
DROP TABLE t1;

#seqDB-22338
CREATE TABLE t1 (
    id INT NOT NULL PRIMARY KEY,
    name VARCHAR(20)
)
PARTITION BY KEY(id)
PARTITIONS 2;
SHOW CREATE TABLE t1;
INSERT INTO t1 VALUES(1,'a'),(2,'b'),(3,'c'),(4,'b'),(5,'f');
--error 131
ALTER TABLE t1 TRUNCATE PARTITION p0;
DROP TABLE t1;

--source include/uninstall_sequoiadb.inc
