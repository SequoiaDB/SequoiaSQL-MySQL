#Case 18635

--source include/have_sequoiadb.inc

#create sessions
connect (con1, localhost, root);
connect (con2, localhost, root);

connection default;
create table t1(a int primary key)engine=sequoiadb; 
connection con1;
select @@autocommit;
connection con2;
select @@autocommit;
#session1 insert
connection con1;
begin;
insert into t1 values(1);

#sesson2 insert error,then select and insert
connection con2;
begin;
--error 1062
insert into t1 values(1); 
select * from t1; 
insert into t1 values(2);
select * from t1;

#session1 commit,then select
connection con1;
commit; 
select * from t1; 

#session2 commit,then select
connection con2;
commit; 
select * from t1;

connection default;
drop table t1;

connection con1;
set session autocommit = 0;
select @@autocommit;
connection con2;
set session autocommit = 0;
select @@autocommit;
connection default;
create table t1(a int primary key)engine=sequoiadb; 
#session1 insert
connection con1;
begin;
insert into t1 values(1);

#sesson2 insert error,then select and insert
connection con2;
begin;
--error 1062
insert into t1 values(1); 
select * from t1; 
insert into t1 values(2);
select * from t1;

#session1 commit,then select
connection con1;
commit; 
select * from t1; 
commit;

#session2 commit,then select
connection con2;
commit; 
select * from t1;
commit;

connection default;
drop table t1;

# MULTI-TABLE
connection default;
create table t1 (id int); 
create table t2 (id int,  s1 text); 
insert into t1 values (1),(2),(3); 
insert into t2 values (1,'test'), (2,'test'), (3,'test'); 
update t1 left join t2 using(id) set s1 = 'changed';  
--sorted_result
select * from t1 left join t2 using(id);

#SEQUOIASQLMAINSTREAM-316
#
# MULTI-UPDATE
#
connection con1;
begin;
update t1 left join t2 using(id) set s1 = 'changed1'; 

connection con2;
--error 40013 
update t1 left join t2 using(ID) set s1 = 'changed2'; 
commit;

connection con1;
commit;

connection default;
--sorted_result
select * from t1 left join t2 using(id);

connection con2;
begin;
update t1 left join t2 using(ID) set s1 = 'test'; 
commit;

connection default;
--sorted_result
select * from t1 left join t2 using(id);

#SEQUOIASQLMAINSTREAM-316
#
# MULTI-DELETE
#
connection con1;
begin;
delete t1, t2 from t1 left join t2 on t1.id=t2.id where t1.id > 1;

connection con2;
--error 40013 
delete t1, t2 from t1 left join t2 on t1.id=t2.id;
commit;

connection con1;
commit;

connection default;
--sorted_result
select * from t1 left join t2 using(id);

connection con2;
begin;
delete t1, t2 from t1 left join t2 on t1.id=t2.id;
commit;
  
connection default;
--sorted_result
select * from t1 left join t2 using(id);

disconnect con1;
disconnect con2;

drop table t1,t2;

--source include/uninstall_sequoiadb.inc
