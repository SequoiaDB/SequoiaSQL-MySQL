# seqDB-30363 、seqDB-30364 、seqDB-30365 、seqDB-30366 、seqDB-30367 、seqDB-30368 、seqDB-30369 、seqDB-30386
--source include/have_sequoiadb.inc

CREATE DATABASE const_cond_sequoiadb;
use const_cond_sequoiadb;

CREATE TABLE const_table(pk int primary key, c1 int, c2 int, c3 TEXT);
CREATE TABLE normal_table(c1 int, c2 int, c3 TEXT);
CREATE TABLE sys_user (
  id bigint not null,
  company_id varchar(64) collate utf8mb4_bin not null,
  office_id varchar(64) collate utf8mb4_bin not null,
  login_name varchar(100) collate utf8mb4_bin not null,
  password varchar(100) collate utf8mb4_bin not null,
  no varchar(100) collate utf8mb4_bin default null,
  del_flag char(1) collate utf8mb4_bin not null default '0',
  primary key(id),
  key office_id(office_id),
  key del_flag(del_flag)
);
CREATE TABLE sys_office(
  id bigint not null,
  parent_ids varchar(2000) collate utf8mb4_bin not null,
  code varchar(100) collate utf8mb4_bin default null,
  del_flag char(1) collate utf8mb4_bin not null default '0',
  primary key(id),
  key del_flag(del_flag)
);

INSERT INTO const_table VALUES( 1, 1, 1, '1' ), ( 2, 2, 2, '2' );
INSERT INTO normal_table VALUES( 1, 1, '1' ), ( 2, 2, '2' );
INSERT INTO sys_user values(13189, '12', '13189', 'aaa', 'bbb', '123', '0');
INSERT INTO sys_office values(13189, '0,1,abc', 'abc', '0');

set session sequoiadb_debug_log = ON;

# seqDB-30368
# IS NULL
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 IS NULL OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 IS NULL OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# IS NOT NULL
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 IS NOT NULL OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 IS NOT NULL OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# seqDB-30366
# =
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 = n.c2 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 = n.c2 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 = 1 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 = 1 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# <=>
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 <=> n.c2 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 <=> n.c2 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 <=> 1 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 <=> 1 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# !=
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 != n.c2 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 != n.c2 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 != 1 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 != 1 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# <
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 < n.c2 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 < n.c2 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 < 1 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 < 1 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# <=
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 <= n.c2 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 <= n.c2 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 <= 1 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 <= 1 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# >
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 > n.c2 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 > n.c2 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 > 1 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 > 1 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# >=
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 >= n.c2 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 >= n.c2 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 >= 1 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 >= 1 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# seqDB-30365
# BETWEEN
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 BETWEEN 1 AND 3 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 BETWEEN 1 AND 3 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (n.c2 BETWEEN c.c1 AND 3 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (n.c2 BETWEEN c.c1 AND 3 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 BETWEEN n.c2 AND 3 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 BETWEEN n.c2 AND 3 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# IN
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 IN (1, 2, 3) OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 IN (1, 2, 3) OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (n.c2 IN (c.c1, 2, 3) OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (n.c2 IN (c.c1, 2, 3) OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 IN (n.c2, 2, 3) OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 IN (n.c2, 2, 3) OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# seqDB-30364
# LIKE
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c3 LIKE '1%' OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c3 LIKE '1%' OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (n.c3 LIKE c.c3 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (n.c3 LIKE c.c3 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c3 LIKE n.c3 OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c3 LIKE n.c3 OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# seqDB-30363
# AND
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND 
    (((c.c3 LIKE '1%') AND 
      (n.c2 < 2)) OR
     n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND 
    (((c.c3 LIKE '1%') AND 
      (n.c2 < 2)) OR
     n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# OR
# covered above 

# XOR
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND 
    ((((c.c3 LIKE '1%') AND 
      (n.c2 < 2)) OR
     n.c1 < 1) XOR n.c3 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND 
    ((((c.c3 LIKE '1%') AND 
      (n.c2 < 2)) OR
     n.c1 < 1) XOR n.c3 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# seqDB-30386
# NOT
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (NOT (c.c3 <=> '1') OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (NOT (c.c3 <=> '1') OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# func nested func
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (n.c2 = MOD(c.c2, 10) OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (n.c2 = MOD(c.c2, 10) OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c2 = MOD(n.c2, 10) OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c2 = MOD(n.c2, 10) OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# func nested logic
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (n.c2 >= (c.c3 <=> '1') OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (n.c2 >= (c.c3 <=> '1') OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# seqDB-30367
# TRUE
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 IS TRUE OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 IS TRUE OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# FALSE
EXPLAIN SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 IS NOT TRUE OR n.c1 < 1);

SELECT * FROM const_table AS c, normal_table AS n
  WHERE c.pk = 1 AND (c.c1 IS NOT TRUE OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

# seqDB-30369
# JOIN
EXPLAIN SELECT * FROM const_table AS c LEFT JOIN normal_table AS n
  ON c.c1 = n.c1
  WHERE c.pk = 1 AND (c.c1 IS TRUE OR n.c1 < 1);

SELECT * FROM const_table AS c LEFT JOIN normal_table AS n
  ON c.c1 = n.c1
  WHERE c.pk = 1 AND (c.c1 IS TRUE OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

EXPLAIN SELECT * FROM const_table AS c RIGHT JOIN normal_table AS n
  ON c.c1 = n.c1
  WHERE c.pk = 1 AND (c.c1 IS TRUE OR n.c1 < 1);

SELECT * FROM const_table AS c RIGHT JOIN normal_table AS n
  ON c.c1 = n.c1
  WHERE c.pk = 1 AND (c.c1 IS TRUE OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

EXPLAIN SELECT * FROM const_table AS c INNER JOIN normal_table AS n
  ON c.c1 = n.c1
  WHERE c.pk = 1 AND (c.c1 IS TRUE OR n.c1 < 1);

SELECT * FROM const_table AS c INNER JOIN normal_table AS n
  ON c.c1 = n.c1
  WHERE c.pk = 1 AND (c.c1 IS TRUE OR n.c1 < 1);
--source include/query_pushdown_condition_sequoiadb.inc

--disable_warnings

EXPLAIN SELECT * FROM sys_user a LEFT JOIN sys_office o 
  ON o.id = a.office_id 
  WHERE a.del_flag = '0' AND o.id = '13189' AND ( o.id = '1' OR o.parent_ids LIKE '0,1,%' ) 
  ORDER BY o.CODE ,a.NO;

SELECT * FROM sys_user a LEFT JOIN sys_office o 
  ON o.id = a.office_id 
  WHERE a.del_flag = '0' AND o.id = '13189' AND ( o.id = '1' OR o.parent_ids LIKE '0,1,%' ) 
  ORDER BY o.CODE ,a.NO;
--source include/query_pushdown_condition_sequoiadb.inc

EXPLAIN SELECT * FROM sys_user a LEFT JOIN sys_office o 
  ON o.id = a.office_id 
  WHERE a.del_flag = '0' AND o.id = '13189' AND ( o.id = '1' OR o.parent_ids LIKE '0,1,%' OR a.id = 12066 )
  ORDER BY o.CODE ,a.NO;

SELECT * FROM sys_user a LEFT JOIN sys_office o 
  ON o.id = a.office_id 
  WHERE a.del_flag = '0' AND o.id = '13189' AND ( o.id = '1' OR o.parent_ids LIKE '0,1,%' OR a.id = 12066 )
  ORDER BY o.CODE ,a.NO;
--source include/query_pushdown_condition_sequoiadb.inc

set session sequoiadb_debug_log = default;
--enable_warnings

drop table const_table;
drop table normal_table;
drop table sys_office;
drop table sys_user;
DROP DATABASE const_cond_sequoiadb;

